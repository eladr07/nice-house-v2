Index: templates/Management/project_demands_not_yet_paid.html
===================================================================
diff --git a/templates/Management/project_demands_not_yet_paid.html b/templates/Management/project_demands_not_yet_paid.html
new file mode 10644
--- /dev/null	(nonexistent)
+++ b/templates/Management/project_demands_not_yet_paid.html	(revision 4128)
@@ -0,0 +1,59 @@
+{% extends "./template.html" %}
+{% load management_extras %}
+{% block page %}
+<div id="content">
+	<div class="title">
+		<div class="pageTitle">דרישות לפרוייקט {{project}}<br>הוצאה חשבונית ולא התקבל צ'ק</div>
+	</div>
+	<div class="clearBoth"> </div>
+	<br />
+	<table id="attachmentTable" class="dataTable" border="1">
+		<tr>
+			<th></th>
+			<th>PDF</th>
+			<th>חודש</th>
+			<th>חוזים</th>
+			<th>סכום חוזים</th>
+			<th>סכום דרישה</th>
+			<th>פרטי<BR>חשבונית</th>
+			<th>תיקון</th>
+			<th>תזכורות להמשך טיפול</th>
+		</tr>
+		{% for d in demands %}
+			<tr class="{% cycle 'row1' 'row2' %}" objid={{a.id}}>
+				<td><a target="_blank" href="/demands/{{d.id}}"><img src="/site_media/images/documentinfo-48.png" width="15" height="15" alt="פרטים" border="0" /></a></td>
+				<td>
+					<a href="/reports/project_month/{{d.project.id}}/{{d.year}}/{{d.month}}">
+					<img src="/site_media/images/PDF-48.png" width="15" height="15"/>
+					</a>
+				</td>
+				<td>{{ d.month }}/{{ d.year }}</td>
+				<td><a href="/demandsales/?demand_id={{d.id}}">{{d.get_sales.count}}</a></td>
+				<td>{{ d.get_sales_amount }}</td>
+				<td>{{ d.get_total_amount }}</td>
+				<td>
+				{% for i in d.invoices.all %}
+					<a href="/invoices/{{i.id}}" target="_blank">{{i.amount|commaise}}</a><br>
+				{% endfor %}
+				</td>
+				<td>
+				{% if d.is_fixed %}
+				<img src="/site_media/images/update_48.png" width="20" height="20"  alt="תיקון" />
+				{% endif %}
+				</td>
+				<td>
+				{% for r in d.get_open_reminders %}
+					{{ r.content|truncatewords:5 }}
+					<a href="{{r.get_absolute_url}}"><img src="/site_media/images/documentinfo-48.png" width="15" height="15" alt="פרטים" border="0" /></a>
+					<a href="{{r.get_absolute_url}}/do"><img src="/site_media/images/thumbs_up_48.png" width="15" height="15" alt="בצע" border="0" /></a>
+					<br>
+				{% endfor %}
+					<a href="/demands/{{d.id}}/addreminder" class="fancybox">
+						<img src="/site_media/images/add_48.png" width="15" height="15" border="0" alt="הוספה" />
+					</a>
+				</td>
+			</tr>
+		{% endfor %}
+	</table>
+</div>
+{% endblock page %}
Index: templates/Management/demand_deals.html
===================================================================
diff --git a/templates/Management/demand_deals.html b/templates/Management/demand_deals.html
new file mode 10644
--- /dev/null	(nonexistent)
+++ b/templates/Management/demand_deals.html	(revision 4128)
@@ -0,0 +1,293 @@
+<script>
+	var selectedID = 0;
+	var prevClass;
+	$(document).ready(function() {
+		$("input[type!='submit']").attr("class", "inputText");
+		$("#saleTable tr").click(function() {
+			var tr = $(this);
+			if (selectedID > 0)
+				$("#saleTable tr[objid='"+selectedID+"']").attr("class", prevClass);
+			selectedID = tr.attr("objid");
+			if (!selectedID) return;
+			prevClass = tr.attr("class");
+			tr.attr("class","selectedRow");
+			if (selectedID > 0)
+			{//sync links
+				$("#saleEdit").attr("href", "/demands/sale/" + selectedID);
+				$("#saleCommissionEdit").attr("href", "/demands/sale/" + selectedID + "/commission");
+				$("#saleDelete").attr("href", "/demands/{{demand.id}}/sale/" + selectedID + "/cancel");
+				$("#salePre").attr("href", "/demands/{{demand.id}}/sale/" + selectedID + "/pre");
+				$("#saleReject").attr("href", "/demands/{{demand.id}}/sale/" + selectedID + "/reject");
+			}
+		});
+		$("#salePre, #saleReject").click( function(e) {
+			var self = $(this);
+			var form = self.next();
+
+			e.preventDefault();
+
+			if( selectedID > 0 ) {
+				if( self.attr('id') == 'saleReject' ) {
+					if (!confirm("האם אתה בטוח שברצונך לדחות את המכירה?")) {
+						return;
+					}
+				}
+
+				form.fadeToggle(150, function() {
+					$(this).find('form').attr( 'action', self.attr('href') );
+
+					if( form.is(':visible') ) {
+						$(document).bind('click.sale_update', function( event ) {
+							if( form.has(event.target).length === 0 ) {
+								form.hide();
+								$(document).unbind('click.sale_update');
+							}
+						});
+					}
+					else {
+						$(document).unbind('click.sale_update');
+					}
+				});
+			}
+		});
+		$("#saleTable td").attr("style","border-bottom: 1px solid; border-left: 1px solid;");
+		$("#saleDelete").click(function (event) {
+			if (!confirm("האם אתה בטוח שברצונך לבטל את המכירה?"))
+				event.preventDefault();
+		});
+		$(".fancybox").fancybox();
+	});
+</script>
+
+{% load management_extras %}
+
+<div class="clearBoth"></div>
+	<fieldset class="cardFieldset">
+		<legend>פירוט מכירות - {{demand.project}} לחודש {{demand.month}}/{{demand.year}}</legend>
+		<div class="someIcon" style="width:100px;">
+			<img src="/site_media/images/add_48.png" width="20" height="20"  alt="הוספה" />
+				<a href="/demands/{{demand.id}}/sale/add" >הזנת מכירה</a>
+		</div>
+		<div class="someIcon" style="width:100px;">
+			<img src="/site_media/images/edit_48.png" width="20" height="20"  alt="עריכה" />
+			<a id="saleEdit" >עדכון מכירה</a>
+		</div>
+		<div class="someIcon" style="width:120px;">
+			<img src="/site_media/images/edit_48.png" width="20" height="20"  alt="עדכון עמלה" />
+			<a id="saleCommissionEdit" class="fancybox">עדכון עמלה ידנית</a>
+		</div>
+		<div class="someIcon" style="width:100px;">
+			<img src="/site_media/images/agt_forward-48.png" width="20" height="20" alt="הקדמה" border="0" />
+			<a id="salePre">הקדמת מכירה</a>
+			<div class='sale-update'>
+				<form method="GET" class="formTable">
+					<table class="formTable" >
+					{% for field in months %}
+						<tr>
+							<th>{{field.label_tag}}</th>
+							<td>
+								{{field}}
+							</td>
+						</tr>
+					{% endfor %}
+					</table>
+					<input type="submit" value="אישור" class="button"/>
+				</form>
+			</div>
+		</div>
+		<div class="someIcon" style="width:100px;">
+			<img src="/site_media/images/agt_back-48.png" width="20" height="20" alt="דחייה" border="0" />
+			<a id="saleReject">דחיית מכירה</a>
+			<div class='sale-update'>
+				<form method="GET" class="formTable">
+					<table class="formTable" >
+					{% for field in months %}
+						<tr>
+							<th>{{field.label_tag}}</th>
+							<td>
+								{{field}}
+							</td>
+						</tr>
+					{% endfor %}
+					</table>
+					<input type="submit" value="אישור" class="button"/>
+				</form>
+			</div>
+		</div>
+		<div class="someIcon" style="width:100px;">
+			<img src="/site_media/images/delete_48.png" width="20" height="20"  alt="מחיקה" />
+			<a id="saleDelete">ביטול מכירה</a>
+		</div>
+		<div class="someIcon" style="width:120px;">
+			<img src="/site_media/images/print-48.png" width="20" height="20"  alt="הדפסה" />
+			<a href="/reports/project_month/{{demand.project.id}}/{{demand.year}}/{{demand.month}}">לגרסת ההדפסה</a>
+		</div>
+		<table class="formTable" style="float:left;">
+			<tr>
+				<th>נתון שהשתנה</th>
+				<td style="width:20px; background-color:#F69F9F;"></td>
+			</tr>
+			<tr>
+				<th>מכירה מחודש קודם</th>
+				<td style="width:20px; background-color:#F7E1AF;"></td>
+			</tr>
+		</table>
+		<div class="clearBoth"></div>
+		<br>
+		<table class="dataTable" id="saleTable" >
+			<caption>סה"כ {{sales.count}} מכירות בדרישה</caption>
+			<th>מזהה <br>מכירה</th>
+			{% if sales.0.contract_num %}
+			<th>מס' <br>חוזה</th>
+			{% endif %}
+			<th>שם <br>הרוכשים</th>
+			<th>בניין</th>
+			<th>דירה</th>
+			<th>תאריך<br> הרשמה</th>
+			<th>תאריך<br> מכירה</th>
+			<th>מחיר <br>חוזה</th>
+			<th>מחיר חוזה<br>לעמלה</th>
+			{% if sales.0.discount %}
+			<th>מחיר כולל <br>מע"מ</th>
+			<th>% הנחה <br>ניתן</th>
+			<th>% הנחה <br>מותר</th>
+			{% endif %}
+			<th>% עמלת <br>בסיס</th>
+			<th>שווי עמלת <br>בסיס</th>
+			{% if demand.project.commissions.b_discount_save_precentage or demand.project.commissions.c_zilber %}
+			<th>% בונוס <br>חסכון</th>
+			<th>שווי בונוס <br>חסכון</th>
+			{% endif %}
+			<th>% עמלה <br>סופי</th>
+			<th>שווי עמלה <br>סופי</th>
+			<th>תיקונים</th>
+			<th>הערות</th>
+			{% for s in sales %}
+			{% if not s.is_cp_ok %}
+				<tr class="row3" objid={{s.id}}>
+			{% else %}
+				<tr class="{% cycle 'row1' 'row2' %}" objid={{s.id}}>
+			{% endif %}
+				<td><a href="/sale/{{s.id}}">{{demand.id}}-{{forloop.counter}}</a></td>
+				{% if s.contract_num %}<td>{{s.contract_num}}</td>{% endif %}
+				<td>
+					{{s.clients}}
+				</td>
+				<td>
+					<a href="/buildings/{{s.house.building.id}}/pricelist/type1">
+					{{s.house.building}}
+					</a>
+				</td>
+				<td {% if s.salehousemod.id %}style="background-color: #F69F9F;"{% endif %}>
+					<a href="/buildings/{{s.house.building.id}}/house/{{s.house.id}}/type1">
+						{{s.house}}
+					</a>
+				</td>
+				<td>{{s.house.get_signup.date|date:"j/m/Y"}}</td>
+				<td>{{s.sale_date|date:"j/m/Y"}}</td>
+				<td {% if s.salepricemod.id %}style="background-color: #F69F9F;"{% endif %}>
+					{{s.price|commaise}} ש"ח
+				</td>
+				<td>{{s.price_final|commaise}} ש"ח</td>
+				{% if demand.sales_with_discount %}
+				<td>{{s.price_taxed|commaise}}</td>
+				<td>{{s.discount|floatformat:3}}</td>
+				<td>{{s.allowed_discount|floatformat:3}}</td>
+				{% endif %}
+				<td>{{s.pc_base}}</td>
+				<td>{{s.pc_base_worth|commaise}} ש"ח</td>
+				{% if demand.project.commissions.b_discount_save_precentage %}
+					<td>{{s.pb_dsp|floatformat:3}}</td>
+					<td>{% if s.pb_dsp_worth %}{{s.pb_dsp_worth|commaise}} ש"ח{% endif %}</td>
+				{% endif %}
+				{% if demand.project.commissions.c_zilber %}
+					<td>---</td>
+					<td>{% if s.zdb %}{{s.zdb|commaise}} ש"ח{% endif %}</td>
+				{% endif %}
+				<td>{{s.c_final|floatformat:3}}</td>
+				<td><b>{{s.c_final_worth|commaise}} ש"ח</b></td>
+				<td>
+					{% if s.salepricemod %}
+						<a href="/salepricemod/{{s.salepricemod.id}}"><img src="/site_media/images/money-48.png" width="20" height="20" /></a>
+					{% endif %}
+					{% if s.salehousemod %}
+						<a href="/salehousemod/{{s.salehousemod.id}}"><img src="/site_media/images/home-48.png" width="20" height="20" /></a>
+					{% endif %}
+					{% if s.salepre %}
+						<a href="/salepre/{{s.salepre.id}}"><img src="/site_media/images/agt_forward-48.png" width="20" height="20" /></a>
+					{% endif %}
+					{% if s.salereject %}
+						<a href="/salereject/{{s.salereject.id}}"><img src="/site_media/images/agt_back-48.png" width="20" height="20" /></a>
+					{% endif %}
+					{% if s.salecancel %}
+						<a href="/salecancel/{{s.salecancel.id}}"><img src="/site_media/images/delete_48.png" width="20" height="20" /></a>
+					{% endif %}
+				</td>
+				<td>{{s.remarks}}</td>
+			</tr>
+			{% endfor %}
+			{% if demand.get_excluded_sales %}
+				<tr>
+					<td align="center" colspan="20"><b>מכירות שלא נכללות בדרישה</b></td>
+				</tr>
+				{% for s in demand.get_excluded_sales %}
+				<tr class="{% cycle 'row1' 'row2' %}" objid={{s.id}}>
+					<td><a href="/sale/{{s.id}}">{{demand.id}}-{{forloop.counter}}</a></td>
+					{% if s.contract_num %}
+					<td>{{s.contract_num}}</td>
+					{% endif %}
+					<td>{{s.clients}}</td>
+					<td>
+						<a href="/buildings/{{s.house.building.id}}/pricelist/type1">
+							{{s.house.building}}
+						</a>
+					</td>
+					<td>
+						<a href="/buildings/{{s.house.building.id}}/house/{{s.house.id}}/type1">
+							{{s.house}}
+						</a>
+					</td>
+					<td>{{s.house.get_signup.date|date:"j/m/Y"}}</td>
+					<td>{{s.sale_date|date:"j/m/Y"}}</td>
+					<td>{{s.price|commaise}} ש"ח</td>
+					<td>{{s.price_final|commaise}} ש"ח</td>
+					{% if s.discount %}
+					<td colspan="3"></td>
+					{% endif %}
+					<td colspan="2"></td>
+					{% if demand.project.commissions.b_discount_save_precentage %}
+					<td colspan="2"></td>
+					{% endif %}
+					<td colspan="2"></td>
+					<td>
+						{% if s.salepricemod %}
+							<a href="/salepricemod/{{s.salepricemod.id}}"><img src="/site_media/images/money-48.png" width="20" height="20" /></a>
+						{% endif %}
+						{% if s.salehousemod %}
+							<a href="/salehousemod/{{s.salehousemod.id}}"><img src="/site_media/images/home-48.png" width="20" height="20" /></a>
+						{% endif %}
+						{% if s.salepre %}
+							<a href="/salepre/{{s.salepre.id}}"><img src="/site_media/images/agt_forward-48.png" width="20" height="20" /></a>
+						{% endif %}
+						{% if s.salereject %}
+							<a href="/salereject/{{s.salereject.id}}"><img src="/site_media/images/agt_back-48.png" width="20" height="20" /></a>
+						{% endif %}
+						{% if s.salecancel %}
+							<a href="/salecancel/{{s.salecancel.id}}"><img src="/site_media/images/delete_48.png" width="20" height="20" /></a>
+						{% endif %}
+					</td>
+					<td>{{s.remarks}}</td>
+				</tr>
+				{% endfor %}
+			{% endif %}
+			<tr height="40px">
+				<td colspan={% if sales.0.discount %}"7"{%else%}"6"{%endif%}></td>
+				<td><b><u>{{sales.total_price|commaise}} ש"ח</u></b></td>
+				<td><b><u>{{sales.total_price_final|commaise}} ש"ח</u></b></td>
+				<td colspan={% if sales.0.discount %}"5"{%else%}"2"{%endif%}></td>
+				<td colspan={% if demand.project.commissions.b_discount_save_precentage or demand.project.commissions.c_zilber %}"3"{%else%}"1"{%endif%}></td>
+				<td colspan="2"><b><u style="color:#1A339C;">{{demand.sales_commission|commaise}} ש"ח</u></b></td>
+			</tr>
+		</table>
+	</fieldset>
+<div class="clearBoth"></div>
